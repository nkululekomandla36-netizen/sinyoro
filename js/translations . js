/**
 * SINYORO TRANSLATIONS SYSTEM - FIXED VERSION
 */

(function() {
    'use strict';

    const translations = {
        en: {
            brandName: "Community Marketplace",
            navHome: "Home",
            navMarket: "Market",
            navMyItems: "My Items",
            navCommunity: "Community",
            navHelp: "Help",
            postItem: "Post Item",
            profile: "Profile",
            heroTitle: "Trade Without Internet",
            heroDescription: "Buy, sell, and barter essential goods with your nearby community. Works completely offline.",
            featureLocal: "Local Only",
            featureSecure: "Secure",
            featureEssential: "Essential Goods",
            categoriesTitle: "Available Categories",
            catFood: "Food",
            catLivestock: "Livestock",
            catTools: "Tools",
            catServices: "Services",
            catHerbs: "Herbs",
            totalItems: "Total: 18 items available",
            browseMarket: "Browse Market",
            howItWorks: "How It Works",
            checkingConnection: "Checking connection...",
            marketTitle: "üõí Local Market",
            marketSubtitle: "Essential goods from your community",
            filterAll: "All Items",
            loadMore: "Load More",
            contactSeller: "Contact Seller",
            trusted: "Trusted",
            newSeller: "New Seller",
            myItemsTitle: "üì¶ My Items",
            myItemsSubtitle: "Manage your listings and trades",
            noItemsTitle: "No Items Yet",
            noItemsDesc: "Start selling by posting your first item to the marketplace.",
            communityTitle: "ü§ù Community",
            communitySubtitle: "Connect with nearby traders",
            nearbyTraders: "Nearby Traders",
            nearbySummary: "5 traders within 5km of your location",
            viewAllTraders: "View All Traders",
            trustNetwork: "Trust Network",
            trustedTraders: "Trusted Traders",
            successfulTrades: "Successful Trades",
            coverageArea: "Coverage Area",
            helpTitle: "‚ùì How It Works",
            helpSubtitle: "Get started in 3 simple steps",
            step1Title: "Browse Offline",
            step1Desc: "View all items without internet. The marketplace works completely offline using local network.",
            step2Title: "Connect Directly",
            step2Desc: "Contact sellers via SMS or call. No middleman, no fees. Deal directly with your community.",
            step3Title: "Trade & Barter",
            step3Desc: "Buy with cash or barter goods. Flexible trading that works for your community's needs.",
            readyToStart: "Ready to Start Trading?",
            ctaDesc: "Join hundreds of community members already trading on Sinyoro.",
            postItemNow: "Post Your First Item",
            postItemTitle: "Post New Item",
            itemTitleLabel: "Item Title",
            itemCategoryLabel: "Category",
            selectCategory: "Select category...",
            itemPriceLabel: "Price / Barter",
            itemLocationLabel: "Location",
            itemDescriptionLabel: "Description",
            itemImageLabel: "Item Image",
            sellerNameLabel: "Your Name",
            contactMethodLabel: "Contact Method",
            cancel: "Cancel",
            offlineNotice: "‚ÑπÔ∏è This will be saved locally and shared when you connect to the network.",
            footerTagline: "Community Marketplace",
            copyright: "¬© 2024 Sinyoro. Built for rural communities."
        },
        sw: {
            brandName: "Soko la Jamii",
            navHome: "Nyumbani",
            navMarket: "Soko",
            navMyItems: "Vitu Vyangu",
            navCommunity: "Jamii",
            navHelp: "Msaada",
            postItem: "Weka Tangazo",
            heroTitle: "Biashara Bila Mtandao",
            heroDescription: "Nunua, uza, ubadilishe bidhaa muhimu na jamii yako ya karibu.",
            featureLocal: "Ya Karibu Tu",
            featureSecure: "Salama",
            featureEssential: "Bidhaa Muhimu",
            categoriesTitle: "Kategoria Zinazopatikana",
            catFood: "Chakula",
            catLivestock: "Mifugo",
            catTools: "Vifaa",
            catServices: "Huduma",
            catHerbs: "Mimea ya Dawa",
            totalItems: "Jumla: Vitu 18 vinapatikana",
            browseMarket: "Tazama Soko",
            howItWorks: "Jinsi Inavyofanya Kazi",
            checkingConnection: "Inakagua muunganiko...",
            marketTitle: "üõí Soko la Kijiji",
            marketSubtitle: "Bidhaa muhimu kutoka jamii yako",
            filterAll: "Vitu Vyote",
            loadMore: "Pakia Zaidi",
            contactSeller: "Wasiliana na Mchuuzi",
            trusted: "Anaaminika",
            newSeller: "Mchuuzi Mpya",
            myItemsTitle: "üì¶ Vitu Vyangu",
            myItemsSubtitle: "Simamia tangazo zako",
            noItemsTitle: "Hakuna Vitu",
            noItemsDesc: "Anza kuuza kwa kuweka tangazo lako la kwanza.",
            communityTitle: "ü§ù Jamii",
            communitySubtitle: "Ungana na wafanyabiashara",
            nearbyTraders: "Wafanyabiashara wa Karibu",
            nearbySummary: "Wafanyabiashara 5 katika km 5",
            viewAllTraders: "Tazama Wote",
            trustNetwork: "Mtandao wa Amani",
            trustedTraders: "Wafanyabiashara wa Kuaminika",
            successfulTrades: "Biashara za Mafanikio",
            coverageArea: "Eneo la Huduma",
            helpTitle: "‚ùì Jinsi Inavyofanya Kazi",
            helpSubtitle: "Anza kwa hatua 3 rahisi",
            step1Title: "Vinjari Nje ya Mtandao",
            step1Desc: "Tazama vitu vyote bila mtandao.",
            step2Title: "Ungana Moja kwa Moja",
            step2Desc: "Wasiliana na wachuuzi kupitia SMS au simu.",
            step3Title: "Biashara & Ubadilishaji",
            step3Desc: "Nunua kwa pesa au ubadilishe bidhaa.",
            readyToStart: "Tayari Kuanza Biashara?",
            ctaDesc: "Jiunge na mamia ya wanajamii.",
            postItemNow: "Weka Tangazo Lako la Kwanza",
            postItemTitle: "Weka Tangazo Jipya",
            itemTitleLabel: "Jina la Bidhaa",
            itemCategoryLabel: "Kategoria",
            selectCategory: "Chagua kategoria...",
            itemPriceLabel: "Bei / Ubadilishaji",
            itemLocationLabel: "Mahali",
            itemDescriptionLabel: "Maelezo",
            itemImageLabel: "Picha ya Bidhaa",
            sellerNameLabel: "Jina Lako",
            contactMethodLabel: "Njia ya Mawasiliano",
            cancel: "Ghairi",
            offlineNotice: "‚ÑπÔ∏è Hii itahifadhiwa kikanda.",
            footerTagline: "Soko la Jamii",
            copyright: "¬© 2024 Sinyoro. Ilijengwa kwa jamii za vijijini."
        },
        zu: {
            brandName: "Imakethe Yomphakathi",
            navHome: "Ikhaya",
            navMarket: "Imakethe",
            navMyItems: "Izinto Zami",
            navCommunity: "Umphakathi",
            navHelp: "Usizo",
            postItem: "Faka Into",
            heroTitle: "Thenga Ngaphandle Kwe-Intanethi",
            heroDescription: "Thenga, thengisa, faneleke izimpahla ezibalulekile.",
            featureLocal: "Endaweni Kuphela",
            featureSecure: "Iphephile",
            featureEssential: "Izimpahla Ezibalulekile",
            categoriesTitle: "Izigaba Ezitholakalayo",
            catFood: "Ukudla",
            catLivestock: "Izinkomo",
            catTools: "Amathuluzi",
            catServices: "Izinsiza",
            catHerbs: "Imithi Yezifo",
            totalItems: "Isamba: Izinto eziyi-18",
            browseMarket: "Phequlula Imakethe",
            howItWorks: "Ukusebenza Kwayo",
            checkingConnection: "Ihlola uxhumano...",
            marketTitle: "üõí Imakethe Yendawo",
            marketSubtitle: "Izimpahla ezibalulekile",
            filterAll: "Zonke Izinto",
            loadMore: "Layisha Okuningi",
            contactSeller: "Xhumana Nothengisi",
            trusted: "Thembekile",
            newSeller: "Uthengisi Omusha",
            myItemsTitle: "üì¶ Izinto Zami",
            myItemsSubtitle: "Phatha izaziso zakho",
            noItemsTitle: "Azikho Izinto",
            noItemsDesc: "Qala ukuthengisa ngokufaka isaziso sakho sokuqala.",
            communityTitle: "ü§ù Umphakathi",
            communitySubtitle: "Xhumana nothengisi",
            nearbyTraders: "Abathengisi Basondelene",
            nearbySummary: "Abathengisi abangu-5",
            viewAllTraders: "Buka Bonke",
            trustNetwork: "Inethiwekhi Yethemba",
            trustedTraders: "Abathengisi Abathembekile",
            successfulTrades: "Izokuhweba Eziphumelele",
            coverageArea: "Indawo Yokuviwa",
            helpTitle: "‚ùì Ukusebenza Kwayo",
            helpSubtitle: "Qala ngezinyathelo eziyisithupha",
            step1Title: "Phequlula Ngaphandle Kwe-Inthanethi",
            step1Desc: "Buka zonke izinto ngaphandle kwe-inthanethi.",
            step2Title: "Xhumana Ngqo",
            step2Desc: "Xhumana nothengisi nge-SMS noma ngocingo.",
            step3Title: "Thenga & Faneleka",
            step3Desc: "Thenga ngesheli noma faneleke izimpahla.",
            readyToStart: "Ulungele Ukuqala Ukuhweba?",
            ctaDesc: "Joyina amakhulu amalungu omphakathi.",
            postItemNow: "Faka Isaziso Sakho Sokuqala",
            postItemTitle: "Faka Into Entsha",
            itemTitleLabel: "Igama Lento",
            itemCategoryLabel: "Isigaba",
            selectCategory: "Khetha isigaba...",
            itemPriceLabel: "Intengo / Faneleka",
            itemLocationLabel: "Indawo",
            itemDescriptionLabel: "Incazelo",
            itemImageLabel: "Isithombe Sento",
            sellerNameLabel: "Igama Lakho",
            contactMethodLabel: "Indlela Yoxhumana",
            cancel: "Khansela",
            offlineNotice: "üí° Lokhu kuzogcinwa kule ndawo.",
            footerTagline: "Imakethe Yomphakathi",
            copyright: "¬© 2024 Sinyoro. Yakhelwe imiphakathi yasemakhaya."
        },
        sn: {
            brandName: "Musika weVanhu",
            navHome: "Kumba",
            navMarket: "Musika",
            navMyItems: "Zvinhu Zvangu",
            navCommunity: "Vanhu",
            navHelp: "Rubatsiro",
            postItem: "Isa Zvinhu",
            heroTitle: "Itengesane Pasina Internet",
            heroDescription: "Tenga, tengesa, uchange zvinhu zvinokosha.",
            featureLocal: "Yemunharaunda Chete",
            featureSecure: "Yakachengeteka",
            featureEssential: "Zvinhu Zvinokosha",
            categoriesTitle: "Zvakagadzirwa Zvinowanikwa",
            catFood: "Zvokudya",
            catLivestock: "Mhuka",
            catTools: "Zvishandiso",
            catServices: "Mabasa",
            catHerbs: "Mititi",
            totalItems: "Zvese: Zvinhu 18",
            browseMarket: "Tarisa Musika",
            howItWorks: "Maitiro EKushandisa",
            checkingConnection: "Kutarisa kuunganidzwa...",
            marketTitle: "üõí Musika weMunharaunda",
            marketSubtitle: "Zvinhu zvinokosha",
            filterAll: "Zvinhu Zvose",
            loadMore: "Dzika Zvimwe",
            contactSeller: "Taura neMutengesi",
            trusted: "Anogamuchirwa",
            newSeller: "Mutengesi Mutsva",
            myItemsTitle: "üì¶ Zvinhu Zvangu",
            myItemsSubtitle: "Tonga zvinhu zvako",
            noItemsTitle: "Hapana Zvinhu",
            noItemsDesc: "Tanga kutengesa nekusiya chinzvimbo chekutanga.",
            communityTitle: "ü§ù Vanhu",
            communitySubtitle: "Batanidzana navatengesi",
            nearbyTraders: "Vatengesi Vavemunharaunda",
            nearbySummary: "Vatengesi 5 mukati mekm 5",
            viewAllTraders: "Ona Vose",
            trustNetwork: "Nzira Dokuwana",
            trustedTraders: "Vatengesi Vanogamuchirwa",
            successfulTrades: "Zvakabudirira Zvokutengesana",
            coverageArea: "Nzvimbo Inofukidzwa",
            helpTitle: "‚ùì Maitiro EKushandisa",
            helpSubtitle: "Tanga nenzira dziri nyore",
            step1Title: "Vhura Pasina Internet",
            step1Desc: "Ona zvinhu zvose pasina internet.",
            step2Title: "Batanidzana Nekurumidza",
            step2Desc: "Taura navatengesi kubudikidza neSMS.",
            step3Title: "Tengesana & Chengetedza",
            step3Desc: "Tenga nemari kana uchengetedze zvinhu.",
            readyToStart: "Wagadzirira Kutanga Kutengesana?",
            ctaDesc: "Pindura nevamwe zviuru.",
            postItemNow: "Isa Chinzvimbo Chekutanga",
            postItemTitle: "Isa Chinzvimbo Chitsva",
            itemTitleLabel: "Mutoro weChinzvimbo",
            itemCategoryLabel: "Chikamu",
            selectCategory: "Sarudza chikamu...",
            itemPriceLabel: "Mutengo / Kuchengetedza",
            itemLocationLabel: "Nzvimbo",
            itemDescriptionLabel: "Tsanangudzo",
            itemImageLabel: "Mufananidzo weChinzvimbo",
            sellerNameLabel: "Zita Rako",
            contactMethodLabel: "Nzira Dokuwirirana",
            cancel: "Kanzura",
            offlineNotice: "üí° Izvi zvichachengetwa mumusha.",
            footerTagline: "Musika weVanhu",
            copyright: "¬© 2024 Sinyoro. Yakavakwa nemisha yemuno."
        },
        af: {
            brandName: "Gemeenskap Markplein",
            navHome: "Tuis",
            navMarket: "Mark",
            navMyItems: "My Items",
            navCommunity: "Gemeenskap",
            navHelp: "Hulp",
            postItem: "Plaas Item",
            heroTitle: "Handel Sonder Internet",
            heroDescription: "Koop, verkoop en ruil noodsaaklike goedere.",
            featureLocal: "Slegs Plaaslik",
            featureSecure: "Veilig",
            featureEssential: "Noodsaaklike Goedere",
            categoriesTitle: "Beskikbare Kategorie√´",
            catFood: "Kos",
            catLivestock: "Vee",
            catTools: "Gereedskap",
            catServices: "Dienste",
            catHerbs: "Kruie",
            totalItems: "Totaal: 18 items",
            browseMarket: "Blaai Mark",
            howItWorks: "Hoe Dit Werk",
            checkingConnection: "Kontroleer verbinding...",
            marketTitle: "üõí Plaaslike Mark",
            marketSubtitle: "Noodsaaklike goedere",
            filterAll: "Alle Items",
            loadMore: "Laai Meer",
            contactSeller: "Kontak Verkoper",
            trusted: "Betroubaar",
            newSeller: "Nuwe Verkoper",
            myItemsTitle: "üì¶ My Items",
            myItemsSubtitle: "Bestuur jou lyste",
            noItemsTitle: "Nog Geen Items",
            noItemsDesc: "Begin verkoop deur jou eerste item te plaas.",
            communityTitle: "ü§ù Gemeenskap",
            communitySubtitle: "Koppel met handelaars",
            nearbyTraders: "Nabygele√´ Handelaars",
            nearbySummary: "5 handelaars binne 5km",
            viewAllTraders: "Sien Almal",
            trustNetwork: "Vertrouensnetwerk",
            trustedTraders: "Betroubare Handelaars",
            successfulTrades: "Suksesvolle Ruiltransaksies",
            coverageArea: "Dekking Area",
            helpTitle: "‚ùì Hoe Dit Werk",
            helpSubtitle: "Begin in 3 eenvoudige stappe",
            step1Title: "Blaai Vanlyn",
            step1Desc: "Bekyk alle items sonder internet.",
            step2Title: "Koppel Direk",
            step2Desc: "Kontak verkopers via SMS of oproep.",
            step3Title: "Handel & Ruil",
            step3Desc: "Koop met kontant of ruil goedere.",
            readyToStart: "Gereed om te Begin Handel?",
            ctaDesc: "Sluit aan by honderde gemeenskapslede.",
            postItemNow: "Plaas Jou Eerste Item",
            postItemTitle: "Plaas Nuwe Item",
            itemTitleLabel: "Item Titel",
            itemCategoryLabel: "Kategorie",
            selectCategory: "Kies kategorie...",
            itemPriceLabel: "Prys / Ruil",
            itemLocationLabel: "Ligging",
            itemDescriptionLabel: "Beskrywing",
            itemImageLabel: "Item Beeld",
            sellerNameLabel: "Jou Naam",
            contactMethodLabel: "Kontak Metode",
            cancel: "Kanselleer",
            offlineNotice: "üí° Dit sal plaaslik gestoor word.",
            footerTagline: "Gemeenskap Markplein",
            copyright: "¬© 2024 Sinyoro. Gebou vir landelike gemeenskappe."
        }
    };

    let currentLang = localStorage.getItem('sinyoro-language') || 'en';
    let isInitialized = false;

    function init() {
        if (isInitialized) {
            console.log('Translations already initialized');
            return;
        }
        
        console.log('Translations initializing...');
        
        // Check if DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', doInit);
        } else {
            doInit();
        }
    }

    function doInit() {
        if (isInitialized) return;
        
        setupEventListeners();
        applyLanguage(currentLang);
        isInitialized = true;
        console.log('Translations initialized successfully');
    }

    function setupEventListeners() {
        const langBtn = document.getElementById('languageBtn');
        const langDropdown = document.getElementById('langDropdown');
        
        if (!langBtn || !langDropdown) {
            console.error('Language elements not found:', { 
                langBtn: !!langBtn, 
                langDropdown: !!langDropdown 
            });
            return;
        }

        console.log('Setting up language dropdown...');

        // Toggle dropdown on button click
        langBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Language button clicked');
            
            const isOpen = langDropdown.classList.contains('active');
            
            if (isOpen) {
                closeDropdown();
            } else {
                openDropdown();
            }
        });

        // Close when clicking outside
        document.addEventListener('click', function(e) {
            if (!langBtn.contains(e.target) && !langDropdown.contains(e.target)) {
                closeDropdown();
            }
        });

        // Language option clicks
        const langOptions = langDropdown.querySelectorAll('.lang-option');
        console.log('Found language options:', langOptions.length);
        
        langOptions.forEach(function(option) {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const lang = this.getAttribute('data-lang');
                console.log('Language selected:', lang);
                
                if (lang && lang !== currentLang) {
                    changeLanguage(lang);
                }
                closeDropdown();
            });
        });

        // Keyboard accessibility
        langBtn.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                langBtn.click();
            }
        });
    }

    function openDropdown() {
        const langBtn = document.getElementById('languageBtn');
        const langDropdown = document.getElementById('langDropdown');
        
        if (!langBtn || !langDropdown) return;

        langDropdown.classList.add('active');
        langBtn.classList.add('active');
        langBtn.setAttribute('aria-expanded', 'true');
        
        console.log('Dropdown opened');
    }

    function closeDropdown() {
        const langBtn = document.getElementById('languageBtn');
        const langDropdown = document.getElementById('langDropdown');
        
        if (!langBtn || !langDropdown) return;
        
        langDropdown.classList.remove('active');
        langBtn.classList.remove('active');
        langBtn.setAttribute('aria-expanded', 'false');
        
        console.log('Dropdown closed');
    }

    function changeLanguage(lang) {
        if (!translations[lang]) {
            console.error('Unknown language:', lang);
            return;
        }

        currentLang = lang;
        localStorage.setItem('sinyoro-language', lang);
        
        applyLanguage(lang);
        updateActiveOption(lang);
        updateButtonText(lang);
        
        // Show toast notification
        showToast('Language changed to ' + getLanguageName(lang));
    }

    function applyLanguage(lang) {
        const texts = translations[lang];
        if (!texts) return;

        document.querySelectorAll('[data-i18n]').forEach(function(el) {
            const key = el.getAttribute('data-i18n');
            if (texts[key]) {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.hasAttribute('placeholder')) {
                        el.placeholder = texts[key];
                    } else {
                        el.value = texts[key];
                    }
                } else {
                    el.textContent = texts[key];
                }
            }
        });

        document.documentElement.lang = lang;
        console.log('Language applied:', lang);
    }

    function updateActiveOption(lang) {
        const langDropdown = document.getElementById('langDropdown');
        if (!langDropdown) return;

        const options = langDropdown.querySelectorAll('.lang-option');
        options.forEach(function(option) {
            option.classList.remove('active');
            if (option.getAttribute('data-lang') === lang) {
                option.classList.add('active');
            }
        });
    }

    function updateButtonText(lang) {
        const langBtn = document.getElementById('languageBtn');
        if (!langBtn) return;
        
        const currentLangSpan = langBtn.querySelector('.current-lang');
        if (currentLangSpan) {
            currentLangSpan.textContent = getLanguageName(lang);
        }
    }

    function getLanguageName(lang) {
        const names = {
            en: 'English',
            sw: 'Kiswahili',
            zu: 'isiZulu',
            sn: 'ChiShona',
            af: 'Afrikaans'
        };
        return names[lang] || 'English';
    }

    function showToast(message) {
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.style.cssText = 'position:fixed;bottom:2rem;right:2rem;z-index:99999;';
            document.body.appendChild(toastContainer);
        }

        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        toast.style.cssText = 'padding:1rem 1.5rem;margin-bottom:0.5rem;background:rgba(15,23,42,0.98);color:white;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.4);animation:slideIn 0.3s ease;border-left:4px solid #3b82f6;';

        toastContainer.appendChild(toast);
        
        setTimeout(function() { 
            toast.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(function() { toast.remove(); }, 300);
        }, 3000);
    }

    function getText(key) {
        return translations[currentLang]?.[key] || translations['en']?.[key] || key;
    }

    // Initialize immediately if DOM is ready, otherwise wait
    init();

    // Expose globally
    window.SinyoroTranslations = {
        init: init,
        changeLanguage: changeLanguage,
        getCurrentLanguage: function() { return currentLang; },
        getText: getText,
        translations: translations
    };
    
    console.log('Translations script loaded');
})();
