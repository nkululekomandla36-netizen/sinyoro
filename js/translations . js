/**
 * SINYORO TRANSLATIONS SYSTEM v2.0
 * Fixed version - no duplicate event listeners
 */

(function() {
    'use strict';

    // Translation data
    const translations = {
        en: {
            brandName: "Community Marketplace",
            navHome: "Home",
            navMarket: "Market",
            navMyItems: "My Items",
            navCommunity: "Community",
            navHelp: "Help",
            postItem: "Post Item",
            profile: "Profile",
            heroTitle: "Trade Without Internet",
            heroDescription: "Buy, sell, and barter essential goods with your nearby community. Works completely offline.",
            featureLocal: "Local Only",
            featureSecure: "Secure",
            featureEssential: "Essential Goods",
            categoriesTitle: "Available Categories",
            catFood: "Food",
            catLivestock: "Livestock",
            catTools: "Tools",
            catServices: "Services",
            catHerbs: "Herbs",
            totalItems: "Total: 18 items available",
            browseMarket: "Browse Market",
            howItWorks: "How It Works",
            checkingConnection: "Checking connection...",
            offlineStatus: "Offline Mode - Working Locally",
            onlineStatus: "Online - Connected",
            marketTitle: "ðŸ›’ Local Market",
            marketSubtitle: "Essential goods from your community",
            filterAll: "All Items",
            loadMore: "Load More",
            contactSeller: "Contact Seller",
            makeOffer: "Make Offer",
            bookService: "Book Service",
            getQuote: "Get Quote",
            enrollNow: "Enroll Now",
            trusted: "Trusted",
            newSeller: "New Seller",
            myItemsTitle: "ðŸ“¦ My Items",
            myItemsSubtitle: "Manage your listings and trades",
            noItemsTitle: "No Items Yet",
            noItemsDesc: "Start selling by posting your first item to the marketplace.",
            communityTitle: "ðŸ¤ Community",
            communitySubtitle: "Connect with nearby traders",
            nearbyTraders: "Nearby Traders",
            nearbySummary: "5 traders within 5km of your location",
            viewAllTraders: "View All Traders",
            trustNetwork: "Trust Network",
            trustedTraders: "Trusted Traders",
            successfulTrades: "Successful Trades",
            coverageArea: "Coverage Area",
            helpTitle: "â“ How It Works",
            helpSubtitle: "Get started in 3 simple steps",
            step1Title: "Browse Offline",
            step1Desc: "View all items without internet. The marketplace works completely offline using local network.",
            step2Title: "Connect Directly",
            step2Desc: "Contact sellers via SMS or call. No middleman, no fees. Deal directly with your community.",
            step3Title: "Trade & Barter",
            step3Desc: "Buy with cash or barter goods. Flexible trading that works for your community's needs.",
            readyToStart: "Ready to Start Trading?",
            ctaDesc: "Join hundreds of community members already trading on Sinyoro.",
            postItemNow: "Post Your First Item",
            postItemTitle: "Post New Item",
            itemTitleLabel: "Item Title",
            itemCategoryLabel: "Category",
            selectCategory: "Select category...",
            itemPriceLabel: "Price / Barter",
            itemDescriptionLabel: "Description",
            sellerNameLabel: "Your Name",
            cancel: "Cancel",
            offlineNotice: "â„¹ï¸ This will be saved locally and shared when you connect to the network.",
            footerTagline: "Community Marketplace",
            copyright: "Â© 2024 Sinyoro. Built for rural communities.",
            toastItemPosted: "Item posted successfully!",
            toastLanguageChanged: "Language changed to English",
            toastComingSoon: "Coming soon!",
            toastOfflineMode: "You are in offline mode",
            noticeOffline: "ðŸ’¡ This will be saved locally and shared when you connect with nearby users."
        },
        sw: {
            brandName: "Soko la Jamii",
            navHome: "Nyumbani",
            navMarket: "Soko",
            navMyItems: "Vitu Vyangu",
            navCommunity: "Jamii",
            navHelp: "Msaada",
            postItem: "Weka Tangazo",
            profile: "Wasifu",
            heroTitle: "Biashara Bila Mtandao",
            heroDescription: "Nunua, uza, ubadilishe bidhaa muhimu na jamii yako ya karibu. Inafanya kazi bila mtandao.",
            featureLocal: "Ya Karibu Tu",
            featureSecure: "Salama",
            featureEssential: "Bidhaa Muhimu",
            categoriesTitle: "Kategoria Zinazopatikana",
            catFood: "Chakula",
            catLivestock: "Mifugo",
            catTools: "Vifaa",
            catServices: "Huduma",
            catHerbs: "Mimea ya Dawa",
            totalItems: "Jumla: Vitu 18 vinapatikana",
            browseMarket: "Tazama Soko",
            howItWorks: "Jinsi Inavyofanya Kazi",
            checkingConnection: "Inakagua muunganiko...",
            offlineStatus: "Hali ya Nje ya Mtandao - Inafanya Kazi Kikanda",
            onlineStatus: "Mtandaoni - Imeunganishwa",
            marketTitle: "ðŸ›’ Soko la Kijiji",
            marketSubtitle: "Bidhaa muhimu kutoka jamii yako",
            filterAll: "Vitu Vyote",
            loadMore: "Pakia Zaidi",
            contactSeller: "Wasiliana na Mchuuzi",
            makeOffer: "Toa Ofa",
            bookService: "Acha Huduma",
            getQuote: "Pata Bei",
            enrollNow: "Jiandikishe Sasa",
            trusted: "Anaaminika",
            newSeller: "Mchuuzi Mpya",
            myItemsTitle: "ðŸ“¦ Vitu Vyangu",
            myItemsSubtitle: "Simamia tangazo zako na biashara",
            noItemsTitle: "Hakuna Vitu",
            noItemsDesc: "Anza kuuza kwa kuweka tangazo lako la kwanza.",
            communityTitle: "ðŸ¤ Jamii",
            communitySubtitle: "Ungana na wafanyabiashara wa karibu",
            nearbyTraders: "Wafanyabiashara wa Karibu",
            nearbySummary: "Wafanyabiashara 5 katika km 5 za eneo lako",
            viewAllTraders: "Tazama Wafanyabiashara Wote",
            trustNetwork: "Mtandao wa Amani",
            trustedTraders: "Wafanyabiashara wa Kuaminika",
            successfulTrades: "Biashara za Mafanikio",
            coverageArea: "Eneo la Huduma",
            helpTitle: "â“ Jinsi Inavyofanya Kazi",
            helpSubtitle: "Anza kwa hatua 3 rahisi",
            step1Title: "Vinjari Nje ya Mtandao",
            step1Desc: "Tazama vitu vyote bila mtandao. Soko linafanya kazi kabisa nje ya mtandao kwa kutumia mtandao wa ndani.",
            step2Title: "Ungana Moja kwa Moja",
            step2Desc: "Wasiliana na wachuuzi kupitia SMS au simu. Hakuna mshauri, hakuna ada. Fanya biashara moja kwa moja na jamii yako.",
            step3Title: "Biashara & Ubadilishaji",
            step3Desc: "Nunua kwa pesa au ubadilishe bidhaa. Biashara inayobadilika inayofanya kazi kwa mahitaji ya jamii yako.",
            readyToStart: "Tayari Kuanza Biashara?",
            ctaDesc: "Jiunge na mamia ya wanajamii wanaofanya biashara kwenye Sinyoro.",
            postItemNow: "Weka Tangazo Lako la Kwanza",
            postItemTitle: "Weka Tangazo Jipya",
            itemTitleLabel: "Jina la Bidhaa",
            itemCategoryLabel: "Kategoria",
            selectCategory: "Chagua kategoria...",
            itemPriceLabel: "Bei / Ubadilishaji",
            itemDescriptionLabel: "Maelezo",
            sellerNameLabel: "Jina Lako",
            cancel: "Ghairi",
            offlineNotice: "â„¹ï¸ Hii itahifadhiwa kikanda na kushirikiwa unapoungana na watumiaji wa karibu.",
            footerTagline: "Soko la Jamii",
            copyright: "Â© 2024 Sinyoro. Ilijengwa kwa jamii za vijijini.",
            toastItemPosted: "Tangazo limewekwa kwa mafanikio!",
            toastLanguageChanged: "Lugha imebadilishwa kuwa Kiswahili",
            toastComingSoon: "Inakuja hivi karibuni!",
            toastOfflineMode: "Upo katika hali ya nje ya mtandao",
            noticeOffline: "ðŸ’¡ Hii itahifadhiwa kikanda na kushirikiwa unapoungana na watumiaji wa karibu."
        },
        zu: {
            brandName: "Imakethe Yomphakathi",
            navHome: "Ikhaya",
            navMarket: "Imakethe",
            navMyItems: "Izinto Zami",
            navCommunity: "Umphakathi",
            navHelp: "Usizo",
            postItem: "Faka Into",
            profile: "Iphrofayela",
            heroTitle: "Thenga Ngaphandle Kwe-Intanethi",
            heroDescription: "Thenga, thengisa, faneleke izimpahla ezibalulekile nomphakathi wakho osondelene. Isebenza ngaphandle kwe-inthanethi.",
            featureLocal: "Endaweni Kuphela",
            featureSecure: "Iphephile",
            featureEssential: "Izimpahla Ezibalulekile",
            categoriesTitle: "Izigaba Ezitholakalayo",
            catFood: "Ukudla",
            catLivestock: "Izinkomo",
            catTools: "Amathuluzi",
            catServices: "Izinsiza",
            catHerbs: "Imithi Yezifo",
            totalItems: "Isamba: Izinto eziyi-18 ezitholakala",
            browseMarket: "Phequlula Imakethe",
            howItWorks: "Ukusebenza Kwayo",
            checkingConnection: "Ihlola uxhumano...",
            offlineStatus: "Imodi Engaxhunyiwe - Isebenza Endaweni",
            onlineStatus: "Kuxhunyiwe - Ixhumeke",
            marketTitle: "ðŸ›’ Imakethe Yendawo",
            marketSubtitle: "Izimpahla ezibalulekile ezivela emphakathini wakho",
            filterAll: "Zonke Izinto",
            loadMore: "Layisha Okuningi",
            contactSeller: "Xhumana Nothengisi",
            makeOffer: "Enza Isehlulelo",
            bookService: "Bhuka Insiza",
            getQuote: "Thola Isilinganiso",
            enrollNow: "Bhalisa Manje",
            trusted: "Thembekile",
            newSeller: "Uthengisi Omusha",
            myItemsTitle: "ðŸ“¦ Izinto Zami",
            myItemsSubtitle: "Phatha izaziso zakho nezokuhweba",
            noItemsTitle: "Azikho Izinto",
            noItemsDesc: "Qala ukuthengisa ngokufaka isaziso sakho sokuqala.",
            communityTitle: "ðŸ¤ Umphakathi",
            communitySubtitle: "Xhumana nothengisi osondelene",
            nearbyTraders: "Abathengisi Basondelene",
            nearbySummary: "Abathengisi abangu-5 phakathi kwamakhilomitha angu-5",
            viewAllTraders: "Buka Bonke Abathengisi",
            trustNetwork: "Inethiwekhi Yethemba",
            trustedTraders: "Abathengisi Abathembekile",
            successfulTrades: "Izokuhweba Eziphumelele",
            coverageArea: "Indawo Yokuviwa",
            helpTitle: "â“ Ukusebenza Kwayo",
            helpSubtitle: "Qala ngezinyathelo eziyisithupha ezilula",
            step1Title: "Phequlula Ngaphandle Kwe-Inthanethi",
            step1Desc: "Buka zonke izinto ngaphandle kwe-inthanethi. Imakethe isebenza ngokuphelele ngaphandle kwe-inthanethi usebenzisa inethiwekhi yendawo.",
            step2Title: "Xhumana Ngqo",
            step2Desc: "Xhumana nothengisi nge-SMS noma ngocingo. Akukho mmeli, akukho imali. Sebenzisana ngqo nomphakathi wakho.",
            step3Title: "Thenga & Faneleka",
            step3Desc: "Thenga ngesheli noma faneleke izimpahla. Ukuhweba okushintshayo okusebenza emakhalekhukhwini omphakathi wakho.",
            readyToStart: "Ulungele Ukuqala Ukuhweba?",
            ctaDesc: "Joyina amakhulu amalungu omphakathi asebenzisa i-Sinyoro.",
            postItemNow: "Faka Isaziso Sakho Sokuqala",
            postItemTitle: "Faka Into Entsha",
            itemTitleLabel: "Igama Lento",
            itemCategoryLabel: "Isigaba",
            selectCategory: "Khetha isigaba...",
            itemPriceLabel: "Intengo / Faneleka",
            itemDescriptionLabel: "Incazelo",
            sellerNameLabel: "Igama Lakho",
            cancel: "Khansela",
            offlineNotice: "ðŸ’¡ Lokhu kuzogcinwa kule ndawo futhi kabelwe uma uxhumana nabasebenzisi basondelene.",
            footerTagline: "Imakethe Yomphakathi",
            copyright: "Â© 2024 Sinyoro. Yakhelwe imiphakathi yasemakhaya.",
            toastItemPosted: "Into ifakiwe ngempumelelo!",
            toastLanguageChanged: "Ulimi lushintshelwe isiZulu",
            toastComingSoon: "Iyeza kungekudala!",
            toastOfflineMode: "Ukwimodi engaxhunyiwe",
            noticeOffline: "ðŸ’¡ Lokhu kuzogcinwa kule ndawo futhi kabelwe uma uxhumana nabasebenzisi basondelene."
        },
        sn: {
            brandName: "Musika weVanhu",
            navHome: "Kumba",
            navMarket: "Musika",
            navMyItems: "Zvinhu Zvangu",
            navCommunity: "Vanhu",
            navHelp: "Rubatsiro",
            postItem: "Isa Zvinhu",
            profile: "Profile",
            heroTitle: "Itengesane Pasina Internet",
            heroDescription: "Tenga, tengesa, uchange zvinhu zvinokosha nevamwe vemunharaunda yako. Inoshanda pasina internet.",
            featureLocal: "Yemunharaunda Chete",
            featureSecure: "Yakachengeteka",
            featureEssential: "Zvinhu Zvinokosha",
            categoriesTitle: "Zvakagadzirwa Zvinowanikwa",
            catFood: "Zvokudya",
            catLivestock: "Mhuka",
            catTools: "Zvishandiso",
            catServices: "Mabasa",
            catHerbs: "Mititi",
            totalItems: "Zvese: Zvinhu 18 zvinowanikwa",
            browseMarket: "Tarisa Musika",
            howItWorks: "Maitiro EKushandisa",
            checkingConnection: "Kutarisa kuunganidzwa...",
            offlineStatus: "Pasina Internet - Inoshanda Mumusha",
            onlineStatus: "Pane Internet - Yakasungwa",
            marketTitle: "ðŸ›’ Musika weMunharaunda",
            marketSubtitle: "Zvinhu zvinokosha zvemunharaunda yako",
            filterAll: "Zvinhu Zvose",
            loadMore: "Dzika Zvimwe",
            contactSeller: "Taura neMutengesi",
            makeOffer: "Ita Kumbirwa",
            bookService: "Booka Basa",
            getQuote: "Wana Mutengo",
            enrollNow: "Nyoresa Zvino",
            trusted: "Anogamuchirwa",
            newSeller: "Mutengesi Mutsva",
            myItemsTitle: "ðŸ“¦ Zvinhu Zvangu",
            myItemsSubtitle: "Tonga zvinhu zvako nezvokutengesana",
            noItemsTitle: "Hapana Zvinhu",
            noItemsDesc: "Tanga kutengesa nekusiya chinzvimbo chekutanga.",
            communityTitle: "ðŸ¤ Vanhu",
            communitySubtitle: "Batanidzana navatengesi vavemunharaunda",
            nearbyTraders: "Vatengesi Vavemunharaunda",
            nearbySummary: "Vatengesi 5 mukati mekm 5",
            viewAllTraders: "Ona Vatengesi Vose",
            trustNetwork: "Nzira Dokuwana",
            trustedTraders: "Vatengesi Vanogamuchirwa",
            successfulTrades: "Zvakabudirira Zvokutengesana",
            coverageArea: "Nzvimbo Inofukidzwa",
            helpTitle: "â“ Maitiro EKushandisa",
            helpSubtitle: "Tanga nenzira dziri nyore dziri matatu",
            step1Title: "Vhura Pasina Internet",
            step1Desc: "Ona zvinhu zvose pasina internet. Musika unoshanda zvakakwana pasina internet uchishandisa netiweki yemunharaunda.",
            step2Title: "Batanidzana Nekurumidza",
            step2Desc: "Taura navatengesi kubudikidza neSMS kana foni. Hakuna munhu pakati, hakuna mari. Ita basa newe vemunharaunda yako.",
            step3Title: "Tengesana & Chengetedza",
            step3Desc: "Tenga nemari kana uchengetedze zvinhu. Kutengesana kunogona kushanduka kunoshanda pamaitiro emunharaunda yako.",
            readyToStart: "Wagadzirira Kutanga Kutengesana?",
            ctaDesc: "Pindura nevamwe zviuru vavemunharaunda vachishandisa Sinyoro.",
            postItemNow: "Isa Chinzvimbo Chekutanga",
            postItemTitle: "Isa Chinzvimbo Chitsva",
            itemTitleLabel: "Mutoro weChinzvimbo",
            itemCategoryLabel: "Chikamu",
            selectCategory: "Sarudza chikamu...",
            itemPriceLabel: "Mutengo / Kuchengetedza",
            itemDescriptionLabel: "Tsanangudzo",
            sellerNameLabel: "Zita Rako",
            cancel: "Kanzura",
            offlineNotice: "ðŸ’¡ Izvi zvichachengetwa mumusha uye zvichagovana paunobatanidzana navashandisi vavemunharaunda.",
            footerTagline: "Musika weVanhu",
            copyright: "Â© 2024 Sinyoro. Yakavakwa nemisha yemuno.",
            toastItemPosted: "Chinhhu chaiswa zvakanaka!",
            toastLanguageChanged: "Mutauro wachinjwa kuChiShona",
            toastComingSoon: "Chichiuya kare!",
            toastOfflineMode: "Uri mumusika pasina internet",
            noticeOffline: "ðŸ’¡ Izvi zvichachengetwa mumusha uye zvichagovana paunobatanidzana navashandisi vavemunharaunda."
        },
        af: {
            brandName: "Gemeenskap Markplein",
            navHome: "Tuis",
            navMarket: "Mark",
            navMyItems: "My Items",
            navCommunity: "Gemeenskap",
            navHelp: "Hulp",
            postItem: "Plaas Item",
            profile: "Profiel",
            heroTitle: "Handel Sonder Internet",
            heroDescription: "Koop, verkoop en ruil noodsaaklike goedere met jou nabygeleÃ« gemeenskap. Werk heeltemal vanlyn.",
            featureLocal: "Slegs Plaaslik",
            featureSecure: "Veilig",
            featureEssential: "Noodsaaklike Goedere",
            categoriesTitle: "Beskikbare KategorieÃ«",
            catFood: "Kos",
            catLivestock: "Vee",
            catTools: "Gereedskap",
            catServices: "Dienste",
            catHerbs: "Kruie",
            totalItems: "Totaal: 18 items beskikbaar",
            browseMarket: "Blaai Mark",
            howItWorks: "Hoe Dit Werk",
            checkingConnection: "Kontroleer verbinding...",
            offlineStatus: "Vanlyn Modus - Werk Plaaslik",
            onlineStatus: "Aanlyn - Gekoppel",
            marketTitle: "ðŸ›’ Plaaslike Mark",
            marketSubtitle: "Noodsaaklike goedere van jou gemeenskap",
            filterAll: "Alle Items",
            loadMore: "Laai Meer",
            contactSeller: "Kontak Verkoper",
            makeOffer: "Maak 'n Aanbod",
            bookService: "Boek Diens",
            getQuote: "Kry Kwotasie",
            enrollNow: "Skryf Nou In",
            trusted: "Betroubaar",
            newSeller: "Nuwe Verkoper",
            myItemsTitle: "ðŸ“¦ My Items",
            myItemsSubtitle: "Bestuur jou lyste en ruiltransaksies",
            noItemsTitle: "Nog Geen Items",
            noItemsDesc: "Begin verkoop deur jou eerste item op die mark te plaas.",
            communityTitle: "ðŸ¤ Gemeenskap",
            communitySubtitle: "Koppel met nabygeleÃ« handelaars",
            nearbyTraders: "NabygeleÃ« Handelaars",
            nearbySummary: "5 handelaars binne 5km van jou ligging",
            viewAllTraders: "Sien Alle Handelaars",
            trustNetwork: "Vertrouensnetwerk",
            trustedTraders: "Betroubare Handelaars",
            successfulTrades: "Suksesvolle Ruiltransaksies",
            coverageArea: "Dekking Area",
            helpTitle: "â“ Hoe Dit Werk",
            helpSubtitle: "Begin in 3 eenvoudige stappe",
            step1Title: "Blaai Vanlyn",
            step1Desc: "Bekyk alle items sonder internet. Die markplein werk heeltemal vanlyn deur plaaslike netwerk te gebruik.",
            step2Title: "Koppel Direk",
            step2Desc: "Kontak verkopers via SMS of oproep. Geen middelman, geen fooie. Handel direk met jou gemeenskap.",
            step3Title: "Handel & Ruil",
            step3Desc: "Koop met kontant of ruil goedere. Buigsame handel wat werk vir jou gemeenskap se behoeftes.",
            readyToStart: "Gereed om te Begin Handel?",
            ctaDesc: "Sluit aan by honderde gemeenskapslede wat reeds handel op Sinyoro.",
            postItemNow: "Plaas Jou Eerste Item",
            postItemTitle: "Plaas Nuwe Item",
            itemTitleLabel: "Item Titel",
            itemCategoryLabel: "Kategorie",
            selectCategory: "Kies kategorie...",
            itemPriceLabel: "Prys / Ruil",
            itemDescriptionLabel: "Beskrywing",
            sellerNameLabel: "Jou Naam",
            cancel: "Kanselleer",
            offlineNotice: "ðŸ’¡ Dit sal plaaslik gestoor word en gedeel word wanneer jy koppel met nabygeleÃ« gebruikers.",
            footerTagline: "Gemeenskap Markplein",
            copyright: "Â© 2024 Sinyoro. Gebou vir landelike gemeenskappe.",
            toastItemPosted: "Item suksesvol geplaas!",
            toastLanguageChanged: "Taal verander na Afrikaans",
            toastComingSoon: "Kom binnekort!",
            toastOfflineMode: "Jy is in vanlyn modus",
            noticeOffline: "ðŸ’¡ Dit sal plaaslik gestoor word en gedeel word wanneer jy koppel met nabygeleÃ« gebruikers."
        }
    };

    let currentLang = localStorage.getItem('sinyoro-language') || 'en';
    let isInitialized = false;

    // CRITICAL FIX: Only initialize once
    function init() {
        if (isInitialized) {
            console.log('Translator already initialized, skipping...');
            return;
        }
        isInitialized = true;

        console.log('Initializing translator...');
        
        // Apply saved language immediately
        applyLanguage(currentLang);
        
        // Setup event listeners with delay to ensure DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupEventListeners);
        } else {
            // DOM already loaded, setup immediately
            setupEventListeners();
        }
    }

    function setupEventListeners() {
        const langBtn = document.getElementById('languageBtn');
        const langDropdown = document.getElementById('langDropdown');

        if (!langBtn || !langDropdown) {
            console.error('Language selector elements not found');
            return;
        }

        console.log('Setting up language selector listeners');

        // Remove any existing listeners by cloning (nuclear option)
        const newLangBtn = langBtn.cloneNode(true);
        langBtn.parentNode.replaceChild(newLangBtn, langBtn);

        // Toggle dropdown
        newLangBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            this.setAttribute('aria-expanded', !isExpanded);
            this.classList.toggle('active');
            
            // Toggle dropdown visibility
            if (langDropdown.hasAttribute('hidden')) {
                langDropdown.removeAttribute('hidden');
                // Small delay to allow transition
                requestAnimationFrame(() => {
                    langDropdown.classList.add('active');
                });
            } else {
                langDropdown.classList.remove('active');
                setTimeout(() => {
                    langDropdown.setAttribute('hidden', '');
                }, 300);
            }
        });

        // Close when clicking outside
        document.addEventListener('click', function(e) {
            if (!newLangBtn.contains(e.target) && !langDropdown.contains(e.target)) {
                newLangBtn.setAttribute('aria-expanded', 'false');
                newLangBtn.classList.remove('active');
                langDropdown.classList.remove('active');
                setTimeout(() => {
                    langDropdown.setAttribute('hidden', '');
                }, 300);
            }
        });

        // Language option clicks - use event delegation
        langDropdown.addEventListener('click', function(e) {
            const option = e.target.closest('.lang-option');
            if (!option) return;

            e.preventDefault();
            e.stopPropagation();

            const lang = option.getAttribute('data-lang');
            if (lang && lang !== currentLang) {
                changeLanguage(lang);
            }

            // Close dropdown
            newLangBtn.setAttribute('aria-expanded', 'false');
            newLangBtn.classList.remove('active');
            langDropdown.classList.remove('active');
            setTimeout(() => {
                langDropdown.setAttribute('hidden', '');
            }, 300);
        });

        // Update UI
        updateLanguageButton(currentLang);
        updateActiveOption(currentLang);
    }

    function changeLanguage(lang) {
        if (!translations[lang]) {
            console.error('Unknown language:', lang);
            return;
        }

        console.log('Changing language to:', lang);
        currentLang = lang;
        localStorage.setItem('sinyoro-language', lang);

        applyLanguage(lang);
        updateLanguageButton(lang);
        updateActiveOption(lang);
        
        // Dispatch custom event for other scripts
        document.dispatchEvent(new CustomEvent('languageChanged', {
            detail: { language: lang }
        }));

        showToast(translations[lang].toastLanguageChanged || `Language changed to ${lang}`);
    }

    function applyLanguage(lang) {
        const texts = translations[lang];
        if (!texts) return;

        document.querySelectorAll('[data-i18n]').forEach(function(el) {
            const key = el.getAttribute('data-i18n');
            if (texts[key]) {
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    if (el.hasAttribute('placeholder')) {
                        el.placeholder = texts[key];
                    } else {
                        el.value = texts[key];
                    }
                } else {
                    el.textContent = texts[key];
                }
            }
        });

        document.documentElement.lang = lang;
    }

    function updateLanguageButton(lang) {
        const langBtn = document.getElementById('languageBtn');
        if (!langBtn) return;
        
        const currentLangSpan = langBtn.querySelector('.current-lang');
        if (currentLangSpan) {
            const langNames = {
                en: 'English',
                sw: 'Kiswahili',
                zu: 'isiZulu',
                sn: 'ChiShona',
                af: 'Afrikaans'
            };
            currentLangSpan.textContent = langNames[lang] || 'English';
        }
    }

    function updateActiveOption(lang) {
        const langDropdown = document.getElementById('langDropdown');
        if (!langDropdown) return;

        const options = langDropdown.querySelectorAll('.lang-option');
        options.forEach(function(option) {
            option.classList.remove('active');
            if (option.getAttribute('data-lang') === lang) {
                option.classList.add('active');
            }
        });
    }

    function showToast(message) {
        let toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.id = 'toastContainer';
            toastContainer.style.cssText = 'position:fixed;bottom:2rem;right:2rem;z-index:99999;';
            document.body.appendChild(toastContainer);
        }

        const toast = document.createElement('div');
        toast.className = 'glass-card toast';
        toast.textContent = message;
        toast.style.cssText = `
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
            background: rgba(15,23,42,0.98);
            color: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            animation: slideIn 0.3s ease;
            border: 1px solid rgba(255,255,255,0.1);
        `;

        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease forwards';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function getText(key) {
        return translations[currentLang]?.[key] || translations['en']?.[key] || key;
    }

    // Initialize immediately
    init();

    // Expose to window
    window.SinyoroTranslations = {
        init: init,
        changeLanguage: changeLanguage,
        getCurrentLanguage: function() { return currentLang; },
        getText: getText,
        translations: translations
    };
})();
